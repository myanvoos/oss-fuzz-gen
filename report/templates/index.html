{#
Copyright 2024 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

#}{% extends 'base.html' %}

{% block content %}

<style>
td .benchmark .function,
td .signature {
    overflow-wrap: anywhere;
}

td .signature {
    width: fit-content;
    white-space: normal;
    padding: 5px 2px;
    margin: 5px 0 0;
    font-family: monospace;
    font-size: 14px;
    cursor: pointer;
}

.signature a {
    text-decoration: none;
    color: #5389ff;
    font-size: 15px;
}

.dark-mode .sortable-table th:after {
    color: #a0aec0;
}

.dark-mode .sortable-table th[data-sorted="asc"]:after,
.dark-mode .sortable-table th[data-sorted="desc"]:after {
    color: #e5e7eb;
}

.dark-mode .table-index {
    color: #9ca3af;
}

.dark-mode .sortable-table th[data-sorted="desc"]:after {
    content: ' \25b4';
    color: #e5e7eb;
}

.table-index {
    color: #555;
    font-size: 12px;
    text-align: center;
}


.sortable-table th {
    cursor: pointer;
}

.sortable-table th:after {
    content: ' \25be';
    color: #ccc;
}

.sortable-table th[data-sorted="asc"]:after {
    color: #000;
}

.sortable-table th[data-sorted="desc"]:after {
    content: ' \25b4';
    color: #000;
}

.project-group {
    margin-bottom: 1em;
}

.project-header {
    cursor: pointer;
    padding: 16px 20px;
    background: #f3f4f6;  /* gray-100 */
    display: flex;
    align-items: center;
    margin-bottom: 1px;
    position: relative;
}

.dark-mode .project-header {
    background: #333333;
}

.project-header:before {
    content: 'â–¼';
    margin-right: 12px;
    transition: transform 0.2s;
    font-size: 0.8em;
    color: #6b7280;  /* gray-500 */
}

.project-header.collapsed:before {
    transform: rotate(-90deg);
}

.benchmark-group {
    display: block;
    transition: max-height 0.3s ease-out;
}

.benchmark-group.collapsed {
    display: none;
}

.controls {
    margin-bottom: 1em;
}

.controls button {
    margin-right: 10px;
    padding: 5px 10px;
}

.chart-container {
    padding: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.dark-mode .chart-container {
    background: #292929;
}

.chart-row {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.chart-box {
    flex: 1;
    height: 300px;  /* Fixed height */
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
}

.dark-mode .chart-box {
    background: #333333;
}

.sortable-table {
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
}

.sortable-table th {
    background: #f9fafb;  /* gray-50 */
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid #e5e7eb;  /* gray-200 */
}

.dark-mode .sortable-table th {
    background: #333333;
    border-bottom-color: #3d3d3d;
}

.sortable-table td {
    padding: 12px 16px;
    border-bottom: 1px solid #e5e7eb;  /* gray-200 */
}

.dark-mode .sortable-table td {
    border-bottom-color: #3d3d3d;
}

.dark-mode .sortable-table tr:hover td {
    background: #3d3d3d;
}

.status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.status-indicator.running {
    background-color: rgb(253, 96, 96);
}

.status-indicator.completed {
    background-color: #34d399;  /* green-400 */
}

.dark-mode .status-indicator.completed {
    background-color: #10b981;  /* green-500 */
}

.stat-card {
    background: white;
    padding: 1rem;
    border-radius: 0.5rem;
    border: 1px solid #e5e7eb;
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.dark-mode .stat-card {
    background: #292929;
    border-color: #3d3d3d;
}

.stat-label {
    color: #6B7280;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
}

.dark-mode .stat-label {
    color: #9CA3AF;
}

.stat-value {
    color: #111827;
    font-size: 1.5rem;
    font-weight: 600;
}

.dark-mode .stat-value {
    color: #F3F4F6;
}

.filter-btn.active {
    background-color: #3b82f6;  /* blue-500 */
    color: white;
    border-color: #3b82f6;
}

.dark-mode .filter-btn.active {
    background-color: #60a5fa;  /* blue-400 */
    border-color: #60a5fa;
}

.filter-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    background-color: #e5e7eb;
    border-radius: 9999px;
    font-size: 0.875rem;
    color: #374151;
}

.dark-mode .filter-tag {
    background-color: #374151;
    color: #e5e7eb;
}

.filter-tag button {
    color: #6b7280;
    hover:color: #374151;
}

.benchmark-row-hidden {
    display: none;
}

.toc {
    position: fixed;
    right: -400px;
    top: 80px;
    width: 400px;
    background-color: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px 0 0 8px;
    padding: 16px;
    max-height: 80vh;
    overflow-y: auto;
    transition: right 0.3s ease;
    box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
    z-index: 1000;
}

.toc.open {
    right: 0;
}

.toc-toggle {
    position: fixed;
    right: 20px;
    top: 80px;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 8px;
    cursor: pointer;
    z-index: 1001;
    transition: right 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.toc-toggle.open {
    right: 420px;
}

.dark-mode .toc,
.dark-mode .toc-toggle {
    background: #292929;
    border-color: #3d3d3d;
}

.toc-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e5e7eb;
}

.dark-mode .toc-header {
    border-color: #3d3d3d;
}

.toc-tree {
    list-style: none;
    padding-left: 0;
    font-size: 16px;
}

.toc-tree ul {
    list-style: none;
    padding-left: 16px;
    margin: 4px 0;
    border-left: 1px solid #e5e7eb;
}

.dark-mode .toc-tree ul {
    border-color: #3d3d3d;
}

.toc-tree li {
    margin: 8px 0;
    line-height: 1.4;
}

.toc-link {
    color: #374151;
    text-decoration: none;
    display: block;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.2s;
}

.dark-mode .toc-link {
    color: #e5e7eb;
}

.toc-link:hover {
    color: #3b82f6;
    background: #f3f4f6;
}

.dark-mode .toc-link:hover {
    background: #333333;
}

.toc-section {
    font-weight: 600;
    color: #111827;
    margin-bottom: 12px;
}

.dark-mode .toc-section {
    color: #f3f4f6;
}

.toc-project {
    color: #4b5563;
    font-weight: 500;
}

.dark-mode .toc-project {
    color: #d1d5db;
}

.toc-benchmark {
    color: #6b7280;
    font-size: 13px;
}

.dark-mode .toc-benchmark {
    color: #9ca3af;
}
</style>

<div x-data="{
    projectOpen: true,
    languageOpen: true,
    crashesFoundOpen: true,
    ofgMetricsOpen: true,
}" class="space-y-2">

    <div class="border rounded-lg section">
        <button @click="projectOpen = !projectOpen"
                class="w-full p-4 flex justify-between items-center">
            <span class="text-lg font-bold">
                Project summary
            </span>
            <svg class="w-5 h-5 transform transition-transform duration-200"
                 :class="{'rotate-180': projectOpen}"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </button>
        <div x-show="projectOpen"
             class="p-4 border-t">

             <div class="flex justify-between">
                <div class="controls flex gap-2">
                    <button id="expand-all" class="border rounded-lg p-5">
                        Expand All
                    </button>
                    <button id="collapse-all" class="border rounded-lg p-5">
                        Collapse All
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="sortable-table min-w-full" id="summary-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th data-sorted="asc">Project</th>
                            <th data-sort-number>Total benchmarks</th>
                            <th data-sort-number>Successful benchmarks</th>
                            <th data-sort-number>Total coverage gain</th>
                            <th data-sort-number>Total relative gain</th>
                            <th data-sort-number>OSS-Fuzz-Gen total covered lines</th>
                            <th data-sort-number>OSS-Fuzz-Gen new covered lines</th>
                            <th data-sort-number>Existing covered lines</th>
                            <th data-sort-number>Total project lines</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for project in projects %}
                        <tr>
                            <td class="table-index">
                                <!-- {{ loop.index }} -->
                                <button class="w-5 h-5 flex items-center justify-center focus:outline-none" @click="$refs.benchmarks_{{ loop.index }}.classList.toggle('hidden')">
                                    <svg class="w-4 h-4 transform transition-transform duration-200" :class="{'rotate-180': !$refs.benchmarks_{{ loop.index }}.classList.contains('hidden')}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </button>
                            </td>
                            {% set ns = namespace(running=false, bug_found=false) %}
                            <td data-sort-value="{{ project.name }}" class="w-full project">
                                <button @click="$refs.benchmarks_{{ loop.index }}.classList.toggle('hidden')" class="text-left font-medium hover:text-blue-600 focus:outline-none benchmark">
                                    {{ project.name }}
                                    {% set ns = namespace(running=false,
                                        bug_found=false,
                                        aggregated_build_rate=0,
                                        aggregated_crash_rate=0,
                                        aggregated_found_bug=0,
                                        aggregated_max_coverage=0,
                                        aggregated_max_line_coverage_diff=0) %}
                                    {% for benchmark in benchmarks %}
                                        {% if benchmark.project == project.name %}
                                            {% if benchmark.status == "Running" %}
                                                {% set ns.running = true %}
                                            {% endif %}
                                            {% if benchmark.result.found_bug %}
                                                {% set ns.bug_found = true %}
                                                <!-- TODO(myan): Track the average number of bugs as well, in order to  identify if a single benchmark has an exceptionally high bug count making it an outlier that needs priority fixing -->
                                            {% endif %}
                                            {% set ns.aggregated_build_rate = ns.aggregated_build_rate + benchmark.result.build_success_rate %}
                                            {% set ns.aggregated_crash_rate = ns.aggregated_crash_rate + benchmark.result.crash_rate %}
                                            {% set ns.aggregated_found_bug = ns.aggregated_found_bug + benchmark.result.found_bug %}
                                            {% set ns.aggregated_max_coverage = ns.aggregated_max_coverage + benchmark.result.max_coverage %}
                                            {% set ns.aggregated_max_line_coverage_diff = ns.aggregated_max_line_coverage_diff + benchmark.result.max_line_coverage_diff %}
                                        {% endif %}
                                    {% endfor %}
                                    <span class="status-indicator ml-1 {{ 'running' if ns.bug_found else 'completed' }}"></span>
                                </button>
                            </td>
                            <td data-sort-value="{{ project.count }}">{{ project.count }}</td>
                            <td data-sort-value="{{ project.success }}">{{ project.success }}</td>
                            <td data-sort-value="{{ project.coverage_gain|percent }}">{{ project.coverage_gain|percent }}%</td>
                            <td data-sort-value="{{ project.coverage_relative_gain|percent}}">{{ project.coverage_relative_gain | percent }}%</td>
                            <td data-sort-value="{{ project.coverage_ofg_total_covered_lines}}">{{project.coverage_ofg_total_covered_lines}}</td>
                            <td data-sort-value="{{ project.coverage_ofg_total_new_covered_lines}}">{{ project.coverage_ofg_total_new_covered_lines}}</td>
                            <td data-sort-value="{{ project.coverage_existing_total_covered_lines}}">{{ project.coverage_existing_total_covered_lines}}</td>
                            <td data-sort-value="{{ project.coverage_existing_total_lines}}">{{ project.coverage_existing_total_lines}}</td>
                        </tr>
                        <tr>
                            <td colspan="10" class="">
                                <div x-ref="benchmarks_{{ loop.index }}" class="hidden">
                                    <table class="sortable-table min-w-full ml-8">
                                        <thead>
                                            <tr>
                                                <th></th>
                                                <th data-sorted="asc">Benchmark</th>
                                                <th>Status</th>
                                                <th data-sort-number>Build Rate</th>
                                                <th data-sort-number>Crash Rate</th>
                                                <th data-sort-number>Bugs</th>
                                                <th data-sort-number>Program Counter Coverage</th>
                                                <th data-sort-number>Line Coverage Diff</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for benchmark in benchmarks %}
                                            {% if benchmark.project == project.name %}
                                            <tr>
                                                <td class="table-index">
                                                    <!-- {{ loop.index }} -->
                                                    
                                                </td>
                                                <td data-sort-value="{{ benchmark.id }}">
                                                    <pre class="signature benchmark">
                                                        <a href="benchmark/{{ benchmark.id|urlencode }}/index.html">{{ benchmark.signature }}</a>
                                                    </pre>
                                                </td>
                                                <td data-sort-value="{{ benchmark.status }}">{{ benchmark.status }}</td>
                                                <td data-sort-value="{{ benchmark.result.build_success_rate|percent }}">{{ benchmark.result.build_success_rate|percent}}</td>
                                                <td data-sort-value="{{ benchmark.result.crash_rate|percent }}"><a href="benchmark/{{ benchmark.id|urlencode }}/crash.json"> {{ benchmark.result.crash_rate|percent }} </a></td>
                                                <td data-sort-value="{{ benchmark.result.found_bug }}">{{ benchmark.result.found_bug }}</td>
                                                <td data-sort-value="{{ benchmark.result.max_coverage |percent }}">{{ benchmark.result.max_coverage |percent }}</td>
                                                <td data-sort-value="{{ benchmark.result.max_line_coverage_diff|percent }}"><a href="{{ benchmark.result.max_coverage_diff_report | cov_report_link }}">{{ benchmark.result.max_line_coverage_diff|percent }}</a></td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                            <tr class="font-bold">
                                                <td>Average</td>
                                                <td>-</td>
                                                <td>-</td>
                                                <td>{{ (ns.aggregated_build_rate / project.count)|percent }}</td>
                                                <td>{{ (ns.aggregated_crash_rate / project.count)|percent }}</td>
                                                <td>{{ ns.aggregated_found_bug }}</td>
                                                <td>{{ (ns.aggregated_max_coverage / project.count)|percent }}</td>
                                                <td>{{ (ns.aggregated_max_line_coverage_diff / project.count)|percent }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        </div>
    </div>

    <div class="border rounded-lg section">
        <button @click="crashesFoundOpen = !crashesFoundOpen"
                class="w-full p-4 flex justify-between items-center">
            <span class="text-lg font-bold">
                Crashes found by generated fuzz harnesses
            </span>
            <svg class="w-5 h-5 transform transition-transform duration-200"
                 :class="{'rotate-180': crashesFoundOpen}"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </button>
        <div x-show="crashesFoundOpen"
             class="p-4 border-t">
             <table class="sortable-table" id="bug-summary-table">
                <thead>
                    <tr>
                        <th></th>
                        <th data-sort-string>Project</th>
                        <th data-sorted="asc">Benchmark</th>
                        <th data-sort-string>AI bug validation</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bug_sample in samples_with_bugs %}
                    <tr>
                        <td class="table-index">{{ loop.index }}</td>
                        <td data-sort-value="{{bug_sample.benchmark.project}}">{{bug_sample.benchmark.project}}</td>
                        <td data-sort-value="{{bug_sample.benchmark.id}}"><a href="sample/{{ bug_sample.benchmark.id|urlencode }}/{{ bug_sample.sample.id }}.html">{{bug_sample.benchmark.id}}-{{ bug_sample.sample.id }} </a> </td>
                        <td data-sort-value="{{'True positive' if bug_sample.sample.result.is_semantic_error else 'False positive'}}">
                            <span class="p-2 rounded-lg w-[20px] {{ 'bg-red-300 text-black' if bug_sample.sample.result.crashes and not bug_sample.sample.result.is_semantic_error else 'bg-green-300 text-white' }}">
                                {{'True positive' if bug_sample.sample.result.is_semantic_error else 'False positive'}}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="border rounded-lg section">
        <button @click="ofgMetricsOpen = !ofgMetricsOpen"
                class="w-full p-4 flex justify-between items-center">
            <span class="text-lg font-bold">
                OSS-Fuzz-Gen / existing coverage comparison
            </span>
            <svg class="w-5 h-5 transform transition-transform duration-200"
                 :class="{'rotate-180': ofgMetricsOpen}"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </button>

        <div x-show="ofgMetricsOpen"
             class="p-4 border-t">
            <div class="chart-container">
                <div class="chart-row">
                    <div class="chart-box">
                        <canvas id="ofgCoverageComparisonChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <canvas id="ofgCoverageGainChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="border rounded-lg section">
        <button @click="languageOpen = !languageOpen"
                class="w-full p-4 flex justify-between items-center">
            <span class="text-lg font-bold">
                Language coverage
            </span>
            <svg class="w-5 h-5 transform transition-transform duration-200"
                 :class="{'rotate-180': languageOpen}"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </button>

        <div x-show="languageOpen"
             class="p-4 border-t">
             <table class="sortable-table mb-8" id="language-coverage-gain">
                <thead>
                    <th>Language</th>
                    <th>OSS-Fuzz total lines</th>
                    <th>OSS-Fuzz coverage lines</th>
                    <th>Experiment new coverage lines</th>
                    <th>Increase of total</th>
                    <th>Increase of covered</th>
                </thead>
                <tbody>
                    {% for language in coverage_language_gains['coverage_gains_per_language'] %}
                    <tr>
                        <td>{{language}}</td>
                        <td>{{ coverage_language_gains['oss_fuzz_language_status'].get(language, {}).get('total', 'N/A') }}</td>
                        <td>{{ coverage_language_gains['oss_fuzz_language_status'].get(language, {}).get('covered', 'N/A') }}</td>
                        <td>{{ coverage_language_gains['coverage_gains_per_language'].get(language, 'N/A') }}</td>
                        <td>{{ coverage_language_gains['comperative_coverage_gains'].get(language, {}).get('total_coverage_increase', 'N/A') }}%</td>
                        <td>{{ coverage_language_gains['comperative_coverage_gains'].get(language, {}).get('relative_coverage_increase', 'N/A') }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="chart-container">
                <div class="chart-row">
                    <div class="chart-box">
                        <canvas id="languageDistributionChart"></canvas>
                </div>
                <div class="chart-box">
                    <canvas id="ossFuzzLinesChart"></canvas>
                </div>
            </div>
            <div class="chart-row">
                <div class="chart-box">
                    <canvas id="newCoverageChart"></canvas>
                </div>
                <div class="chart-box">
                    <canvas id="coverageIncreaseChart"></canvas>
                </div>
            </div>
        </div>
    </div>


</div>

<button class="toc-toggle" id="tocToggle">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
</button>

<div id="toc" class="toc">
    <div class="toc-header">
        <h3 class="text-lg font-semibold">Table of Contents</h3>
    </div>
    <ul class="toc-tree" id="toc-tree"></ul>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('expand-all').addEventListener('click', () => {
        document.querySelectorAll('[x-ref^="benchmarks_"]').forEach(el => {
            el.classList.remove('hidden');
        });
    });

    document.getElementById('collapse-all').addEventListener('click', () => {
        document.querySelectorAll('[x-ref^="benchmarks_"]').forEach(el => {
            el.classList.add('hidden');
        });
    });

    const tocTree = document.getElementById('toc-tree');
    const sections = document.querySelectorAll('.section');
    
    sections.forEach((section, index) => {
        const sectionLi = document.createElement('li');
        const sectionLink = document.createElement('a');
        const sectionTitle = section.querySelector('.text-lg.font-bold');
        sectionLink.textContent = sectionTitle.textContent.trim();
        sectionLink.href = `#section-${index}`;
        sectionLink.className = 'toc-link toc-section';
        section.id = `section-${index}`;
        sectionLi.appendChild(sectionLink);

        if (sectionTitle.textContent.includes('Project summary')) {
            const projectsUl = document.createElement('ul');
            const projectButtons = document.querySelectorAll('button.benchmark');
            
            projectButtons.forEach(projectBtn => {
                const projectName = projectBtn.textContent.trim();
                const projectLi = document.createElement('li');
                const projectLink = document.createElement('a');
                projectLink.textContent = projectName;
                projectLink.href = `#project-${projectName}`;
                projectLink.className = 'toc-link toc-project';
                projectLi.appendChild(projectLink);

                const benchmarksContainer = projectBtn.closest('tr').nextElementSibling;
                if (benchmarksContainer) {
                    const benchmarks = benchmarksContainer.querySelectorAll('pre.signature.benchmark a');
                    if (benchmarks.length > 0) {
                        const benchmarksUl = document.createElement('ul');
                        benchmarks.forEach(benchmark => {
                            const benchmarkLi = document.createElement('li');
                            const benchmarkLink = document.createElement('a');
                            benchmarkLink.textContent = benchmark.textContent.trim().split("-")[2];
                            benchmarkLink.href = benchmark.href;
                            benchmarkLink.className = 'toc-link toc-benchmark';
                            benchmarkLi.appendChild(benchmarkLink);
                            benchmarksUl.appendChild(benchmarkLi);
                        });
                        projectLi.appendChild(benchmarksUl);
                    }
                }
                
                projectsUl.appendChild(projectLi);
            });
            sectionLi.appendChild(projectsUl);
        }
        
        tocTree.appendChild(sectionLi);
    });

    // Toggle functionality
    const toc = document.getElementById('toc');
    const tocToggle = document.getElementById('tocToggle');
    
    tocToggle.addEventListener('click', () => {
        toc.classList.toggle('open');
        tocToggle.classList.toggle('open');
    });

    document.addEventListener('click', (e) => {
        if (!toc.contains(e.target) && !tocToggle.contains(e.target) && toc.classList.contains('open')) {
            toc.classList.remove('open');
            tocToggle.classList.remove('open');
        }
    });
});

(function() {
    tables = Array.from(document.querySelectorAll('table.sortable-table'));
    for (let tbl_idx1 = 0; tbl_idx1 < tables.length; tbl_idx1++) {
        table_element = tables[tbl_idx1];
        const table_id_name = table_element.id;
        headers = Array.from(table_element.querySelectorAll('th'));
        headers.map(
            (th, colindex) => th.addEventListener('click', () => {
                const sortAsc = th.dataset.sorted != "asc";
                const sortNumber = th.dataset.sortNumber != undefined;

                // Move sorted data attribute to the right column
                headers.map(innerTH => delete innerTH.dataset.sorted);
                th.dataset.sorted = sortAsc ? "asc" : "desc";

                // Find the relevant table and sort it accordingly.
                inner_tables = Array.from(document.querySelectorAll('table.sortable-table'));
                for (let tbl_idx2 = 0; tbl_idx2 < inner_tables.length; tbl_idx2++) {
                    the_table = inner_tables[tbl_idx2];
                    if (the_table.id == table_id_name) {
                        const tbody = the_table.querySelector('tbody');
                        const rows = Array.from(tbody.children);
                        rows.sort((a, b) => {
                            let [valueA, valueB] = [a.children[colindex].dataset.sortValue, b.children[colindex].dataset.sortValue];
                            // Swap the values for descending.
                            if (!sortAsc) {
                                [valueB, valueA] = [valueA, valueB];
                            }

                            if (sortNumber) {
                                return Number(valueB) - Number(valueA);
                            }
                            return valueA.localeCompare(valueB);
                        });
                        tbody.replaceChildren(...rows);
                        // Rewrite the index column
                        rows.map((r, i) => r.children[0].innerText = i);
                    }
                }
            }, )
        );

    }
})();

document.addEventListener('DOMContentLoaded', function() {
    const languageColors = {
        {% for language in coverage_language_gains['coverage_gains_per_language'].keys() %}
            '{{ language }}': 'rgba(59, 130, 246, 0.5)', // blue-500 with opacity
        {% endfor %}
    };

    // Common colors
    const blueColor = {
        fill: 'rgba(59, 130, 246, 0.5)',  // blue-500 with opacity
        border: 'rgb(59, 130, 246)',      // blue-500 solid
        point: 'rgb(59, 130, 246)'        // blue-500 solid
    };

    const greenColor = {
        fill: 'rgba(16, 185, 129, 0.5)',  // green-500 with opacity
        border: 'rgb(16, 185, 129)',      // green-500 solid
        point: 'rgb(16, 185, 129)'        // green-500 solid
    };

    const purpleColor = {
        fill: 'rgba(139, 92, 246, 0.5)',  // purple-500 with opacity
        border: 'rgb(139, 92, 246)',      // purple-500 solid
        point: 'rgb(139, 92, 246)'        // purple-500 solid
    };

    // Common options for better scaling
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    };

    const languageDistributionCtx = document.getElementById('languageDistributionChart');
    if (languageDistributionCtx) {
        new Chart(languageDistributionCtx, {
            type: 'pie',
            data: {
                labels: {{ coverage_language_gains['coverage_gains_per_language'].keys()|list|tojson }},
                datasets: [{
                    data: [
                        {% for language in coverage_language_gains['coverage_gains_per_language'].keys() %}
                            {{ coverage_language_gains['oss_fuzz_language_status'][language]['total'] }}{{ "," if not loop.last }}
                        {% endfor %}
                    ],
                    backgroundColor: [blueColor.fill, greenColor.fill, purpleColor.fill],
                    borderColor: [blueColor.border, greenColor.border, purpleColor.border]
                }]
            },
            options: {
                ...commonOptions,
                plugins: {
                    ...commonOptions.plugins,
                    title: {
                        display: true,
                        text: 'Distribution of Languages by Total Lines'
                    },
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    }

    const ossFuzzCtx = document.getElementById('ossFuzzLinesChart');
    if (ossFuzzCtx) {
        new Chart(ossFuzzCtx, {
            type: 'bar',
            data: {
                labels: {{ coverage_language_gains['coverage_gains_per_language'].keys()|list|tojson }},
                datasets: [{
                    label: 'Total Lines',
                    data: [
                        {% for language in coverage_language_gains['coverage_gains_per_language'].keys() %}
                            {{ coverage_language_gains['oss_fuzz_language_status'][language]['total'] }}{{ "," if not loop.last }}
                        {% endfor %}
                    ],
                    backgroundColor: blueColor.fill,
                    borderColor: blueColor.border,
                    borderWidth: 1
                }, {
                    label: 'Covered Lines',
                    data: [
                        {% for language in coverage_language_gains['coverage_gains_per_language'].keys() %}
                            {{ coverage_language_gains['oss_fuzz_language_status'][language]['covered'] }}{{ "," if not loop.last }}
                        {% endfor %}
                    ],
                    backgroundColor: greenColor.fill,
                    borderColor: greenColor.border,
                    borderWidth: 1
                }]
            },
            options: {
                ...commonOptions,
                plugins: {
                    ...commonOptions.plugins,
                    title: {
                        display: true,
                        text: 'OSS-Fuzz Coverage Status by Language'
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Lines'
                        }
                    }
                }
            }
        });
    }

    const newCoverageCtx = document.getElementById('newCoverageChart');
    if (newCoverageCtx) {
        new Chart(newCoverageCtx, {
            type: 'bar',
            data: {
                labels: {{ coverage_language_gains['coverage_gains_per_language'].keys()|list|tojson }},
                datasets: [{
                    label: 'New Coverage Lines',
                    data: [
                        {% for language in coverage_language_gains['coverage_gains_per_language'].keys() %}
                            {{ coverage_language_gains['coverage_gains_per_language'][language] }}{{ "," if not loop.last }}
                        {% endfor %}
                    ],
                    backgroundColor: blueColor.fill,
                    borderColor: blueColor.border,
                    borderWidth: 1
                }]
            },
            options: {
                ...commonOptions,
                plugins: {
                    ...commonOptions.plugins,
                    title: {
                        display: true,
                        text: 'New Lines Covered by Language'
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of New Lines'
                        }
                    }
                }
            }
        });
    }

    const coverageIncreaseCtx = document.getElementById('coverageIncreaseChart');
    if (coverageIncreaseCtx) {
        new Chart(coverageIncreaseCtx, {
            type: 'bar',
            data: {
                labels: {{ coverage_language_gains['coverage_gains_per_language'].keys()|list|tojson }},
                datasets: [{
                    label: 'Total Coverage Increase',
                    data: [
                        {% for language in coverage_language_gains['coverage_gains_per_language'].keys() %}
                            {{ coverage_language_gains['comperative_coverage_gains'][language]['total_coverage_increase'] }}{{ "," if not loop.last }}
                        {% endfor %}
                    ],
                    backgroundColor: blueColor.fill,
                    borderColor: blueColor.border,
                    borderWidth: 1
                }, {
                    label: 'Relative Coverage Increase',
                    data: [
                        {% for language in coverage_language_gains['coverage_gains_per_language'].keys() %}
                            {{ coverage_language_gains['comperative_coverage_gains'][language]['relative_coverage_increase'] }}{{ "," if not loop.last }}
                        {% endfor %}
                    ],
                    backgroundColor: greenColor.fill,
                    borderColor: greenColor.border,
                    borderWidth: 1
                }]
            },
            options: {
                ...commonOptions,
                plugins: {
                    ...commonOptions.plugins,
                    title: {
                        display: true,
                        text: 'Coverage Increase Comparison'
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Coverage Increase (%)'
                        },
                        ticks: {
                            callback: value => value + '%'
                        }
                    }
                }
            }
        });
    }

    const searchInput = document.getElementById('searchInput');
    const activeFilters = new Set();

    function updateFilters() {
        const filterTags = Array.from(activeFilters).map(filter => {
            return `<span class="filter-tag">
                        ${filter}
                        <button onclick="removeFilter('${filter}')">&times;</button>
                    </span>`;
        }).join('');
        document.getElementById('activeFilters').innerHTML = filterTags;
    }

    window.toggleFilter = function(filter) {
        const btn = document.getElementById(`${filter}Filter`);
        if (activeFilters.has(filter)) {
            activeFilters.delete(filter);
            btn.classList.remove('active');
        } else {
            activeFilters.add(filter);
            btn.classList.add('active');
        }
        updateFilters();
        applyFilters();
    }

    window.removeFilter = function(filter) {
        activeFilters.delete(filter);
        document.getElementById(`${filter}Filter`).classList.remove('active');
        updateFilters();
        applyFilters();
    }

    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const rows = document.querySelectorAll('.sortable-table tbody tr');

        rows.forEach(row => {
            let shouldShow = true;
            const signature = row.querySelector('.signature')?.textContent.toLowerCase() || '';
            const status = row.querySelector('td[data-sort-value]')?.dataset.sortValue.toLowerCase() || '';
            const bugs = parseInt(row.querySelector('td[data-sort-value]:nth-of-type(6)')?.textContent || '0');
            const crashes = parseFloat(row.querySelector('td[data-sort-value]:nth-of-type(5)')?.textContent || '0');

            // Search term filter
            if (searchTerm && !signature.includes(searchTerm)) {
                shouldShow = false;
            }

            // Active filters
            if (activeFilters.has('bugs') && bugs === 0) {
                shouldShow = false;
            }
            if (activeFilters.has('crashes') && crashes === 0) {
                shouldShow = false;
            }
            if (activeFilters.has('running') && status !== 'running') {
                shouldShow = false;
            }

            row.classList.toggle('benchmark-row-hidden', !shouldShow);
        });

        document.querySelectorAll('.project-group').forEach(project => {
            const visibleBenchmarks = project.querySelectorAll('tbody tr:not(.benchmark-row-hidden)').length;
            project.classList.toggle('benchmark-row-hidden', visibleBenchmarks === 0);
        });
    }

    searchInput.addEventListener('input', applyFilters);

    const ofgCoverageCtx = document.getElementById('ofgCoverageComparisonChart');
    if (ofgCoverageCtx) {
        new Chart(ofgCoverageCtx, {
            type: 'bar',
            data: {
                labels: {{ projects|map(attribute='name')|list|tojson }},
                datasets: [{
                    label: 'OSS-Fuzz-Gen Covered Lines',
                    data: [
                        {% for project in projects %}
                            {{ project.coverage_ofg_total_covered_lines }}{{ "," if not loop.last }}
                        {% endfor %}
                    ],
                    backgroundColor: blueColor.fill,
                    borderColor: blueColor.border,
                    borderWidth: 1
                }, {
                    label: 'Existing Covered Lines',
                    data: [
                        {% for project in projects %}
                            {{ project.coverage_existing_total_covered_lines }}{{ "," if not loop.last }}
                        {% endfor %}
                    ],
                    backgroundColor: greenColor.fill,
                    borderColor: greenColor.border,
                    borderWidth: 1
                }]
            },
            options: {
                ...commonOptions,
                plugins: {
                    ...commonOptions.plugins,
                    title: {
                        display: true,
                        text: 'OSS-Fuzz-Gen vs Existing Coverage Comparison'
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Lines'
                        }
                    }
                }
            }
        });
    }

    const ofgGainCtx = document.getElementById('ofgCoverageGainChart');
    if (ofgGainCtx) {
        new Chart(ofgGainCtx, {
            type: 'bar',
            data: {
                labels: {{ projects|map(attribute='name')|list|tojson }},
                datasets: [{
                    label: 'New Covered Lines',
                    data: [
                        {% for project in projects %}
                            {{ project.coverage_ofg_total_new_covered_lines }}{{ "," if not loop.last }}
                        {% endfor %}
                    ],
                    backgroundColor: blueColor.fill,
                    borderColor: blueColor.border,
                    borderWidth: 1,
                    yAxisID: 'y-lines'
                }, {
                    label: 'Relative Coverage Gain (%)',
                    data: [
                        {% for project in projects %}
                            {{ project.coverage_relative_gain * 100 }}{{ "," if not loop.last }}
                        {% endfor %}
                    ],
                    type: 'line',
                    borderColor: greenColor.border,
                    backgroundColor: greenColor.fill,
                    borderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: greenColor.point,
                    yAxisID: 'y-percentage',
                    datalabels: {
                        align: 'top',
                        anchor: 'bottom',
                        formatter: value => value.toFixed(1) + '%'
                    }
                }]
            },
            options: {
                ...commonOptions,
                plugins: {
                    ...commonOptions.plugins,
                    datalabels: {
                        color: 'rgb(239, 68, 68)',
                        font: {
                            weight: 'bold',
                            size: 11
                        },
                        display: true
                    },
                    title: {
                        display: true,
                        text: 'New Lines and Relative Gains by OSS-Fuzz-Gen'
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    'y-lines': {
                        type: 'linear',
                        position: 'left',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Lines'
                        }
                    },
                    'y-percentage': {
                        type: 'linear',
                        position: 'right',
                        beginAtZero: true,
                        suggestedMax: 100,
                        title: {
                            display: true,
                            text: 'Relative Coverage Gain (%)'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
    }
});

// Update getProjectData to handle non-percentage metrics correctly
function getProjectData(projectName, metric) {
    const projects = [
        {% for project in projects %}
        {
            name: "{{ project.name }}",
            count: {{ project.count }},
            success: {{ project.success }},
            coverage_gain: {{ project.coverage_gain }},
            coverage_relative_gain: {{ project.coverage_relative_gain }},
            coverage_ofg_total_covered_lines: {{ project.coverage_ofg_total_covered_lines }},
            coverage_ofg_total_new_covered_lines: {{ project.coverage_ofg_total_new_covered_lines }},
            coverage_existing_total_covered_lines: {{ project.coverage_existing_total_covered_lines }},
            coverage_existing_total_lines: {{ project.coverage_existing_total_lines }},
            aggregated_metrics: {
                {% set ns = namespace(
                    aggregated_build_rate=0,
                    aggregated_crash_rate=0,
                    aggregated_found_bug=0,
                    aggregated_max_coverage=0,
                    aggregated_max_line_coverage_diff=0
                ) %}
                {% for benchmark in benchmarks if benchmark.project == project.name %}
                    {% set ns.aggregated_build_rate = ns.aggregated_build_rate + benchmark.result.build_success_rate %}
                    {% set ns.aggregated_crash_rate = ns.aggregated_crash_rate + benchmark.result.crash_rate %}
                    {% set ns.aggregated_found_bug = ns.aggregated_found_bug + benchmark.result.found_bug %}
                    {% set ns.aggregated_max_coverage = ns.aggregated_max_coverage + benchmark.result.max_coverage %}
                    {% set ns.aggregated_max_line_coverage_diff = ns.aggregated_max_line_coverage_diff + benchmark.result.max_line_coverage_diff %}
                {% endfor %}
                build_rate: {{ ns.aggregated_build_rate / project.count }},
                crash_rate: {{ ns.aggregated_crash_rate / project.count }},
                found_bug: {{ ns.aggregated_found_bug / project.count }},  // Changed to absolute number
                pc_coverage: {{ ns.aggregated_max_coverage / project.count }},
                line_coverage_diff: {{ ns.aggregated_max_line_coverage_diff / project.count }}
            }
        }{{ "," if not loop.last }}
        {% endfor %}
    ];

    const projectData = projects.find(p => p.name === projectName);
    if (!projectData) return 0;

    // Handle aggregated metrics differently
    if (metric in projectData.aggregated_metrics) {
        return projectData.aggregated_metrics[metric];
    }

    return projectData[metric];
}

function formatMetricValue(value, metric) {
    // List of metrics that should be displayed as percentages
    const percentageMetrics = ['build_rate', 'crash_rate', 'pc_coverage', 'line_coverage_diff', 'coverage_gain', 'coverage_relative_gain'];

    if (percentageMetrics.includes(metric)) {
        return formatPercent(value);
    }
    return value.toString();
}

function formatPercent(value) {
    return (value * 100).toFixed(2) + '%';
}

function updateComparisonChart(selectedProjects) {
    const ctxCoverage = document.getElementById('coverageComparisonChart');
    if (window.coverageChart) window.coverageChart.destroy();

    window.coverageChart = new Chart(ctxCoverage, {
        type: 'bar',
        data: {
            labels: selectedProjects,
            datasets: [{
                label: 'Program Counter Coverage',
                data: selectedProjects.map(p => getProjectData(p, 'pc_coverage') * 100),
                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                borderColor: 'rgb(59, 130, 246)',
                borderWidth: 1
            }, {
                label: 'Line Coverage Difference',
                data: selectedProjects.map(p => getProjectData(p, 'line_coverage_diff') * 100),
                backgroundColor: 'rgba(16, 185, 129, 0.5)',
                borderColor: 'rgb(16, 185, 129)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Coverage Metrics Comparison'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Percentage (%)'
                    }
                }
            }
        }
    });

    const ctxRates = document.getElementById('ratesComparisonChart');
    if (window.ratesChart) window.ratesChart.destroy();

    window.ratesChart = new Chart(ctxRates, {
        type: 'bar',
        data: {
            labels: selectedProjects,
            datasets: [{
                label: 'Build Success Rate (%)',
                data: selectedProjects.map(p => getProjectData(p, 'build_rate') * 100),
                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                borderColor: 'rgb(59, 130, 246)',
                borderWidth: 1,
                yAxisID: 'y-rates'
            }, {
                label: 'Crash Rate (%)',
                data: selectedProjects.map(p => getProjectData(p, 'crash_rate') * 100),
                backgroundColor: 'rgba(239, 68, 68, 0.5)',
                borderColor: 'rgb(239, 68, 68)',
                borderWidth: 1,
                yAxisID: 'y-rates'
            }, {
                label: 'Found Bugs (Count)',
                data: selectedProjects.map(p => getProjectData(p, 'found_bug')),
                backgroundColor: 'rgba(16, 185, 129, 0.5)',
                borderColor: 'rgb(16, 185, 129)',
                borderWidth: 1,
                yAxisID: 'y-bugs'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Success Rates and Bugs Found'
                }
            },
            scales: {
                'y-rates': {
                    type: 'linear',
                    position: 'left',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Rate (%)'
                    },
                    max: 100
                },
                'y-bugs': {
                    type: 'linear',
                    position: 'right',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Bugs'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}
